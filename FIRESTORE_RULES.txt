// Copy and paste these rules into Firebase Console → Firestore Database → Rules tab

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read any user document, but only write their own
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Groups: only members can read, creator can write/update
    // Also allow users to update when adding themselves via invite acceptance
    match /groups/{groupId} {
      // Allow reading if user is a member, OR allow queries (needed for join by code lookups)
      allow read: if request.auth != null && (
        request.auth.uid in resource.data.members ||
        // Allow queries (getDocs with where clause) for join code lookups
        // This is less secure but necessary for the join by code feature
        // Consider adding a separate collection for public join codes if you need better security
        true
      );
      allow create: if request.auth != null && request.auth.uid == request.resource.data.createdBy;
      // Creator can update, OR user can update if they're adding themselves to members
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.createdBy ||
        // User can add themselves to members list if they're not already a member
        (request.auth.uid in request.resource.data.members && 
         !(request.auth.uid in resource.data.members))
      );
    }
    
    // Expenses: only authenticated users can read/write
    match /expenses/{expenseId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && 
        request.auth.uid == request.resource.data.createdBy;
    }
    
    // Activities: only authenticated users can read/write
    match /activities/{activityId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }
    
    // Invites: users can read their own invites, group creators can create invites
    match /invites/{inviteId} {
      // Users can read invites sent to their email
      allow read: if request.auth != null && 
        request.auth.token.email != null &&
        resource.data.invitedEmail == request.auth.token.email.toLowerCase();
      
      // Group creators can create invites for their groups
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.invitedBy;
      
      // Users can update invites sent to their email (accept/decline)
      allow update: if request.auth != null && 
        request.auth.token.email != null &&
        resource.data.invitedEmail == request.auth.token.email.toLowerCase();
      
      // Group creators can delete their invites
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.invitedBy;
    }
  }
}

